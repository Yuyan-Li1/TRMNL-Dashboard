name: Health Check

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'

  workflow_dispatch:

jobs:
  health:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check dashboard health
        id: health
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            "https://${{ secrets.VERCEL_URL }}/api/health")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Health response: $body"
          echo "HTTP Status: $http_code"

          # Parse JSON for individual service status
          echo "health_status=$http_code" >> $GITHUB_OUTPUT
          echo "response=$body" >> $GITHUB_OUTPUT

          if [ "$http_code" != "200" ]; then
            echo "Health check failed"
            exit 1
          fi

      - name: Check token health
        run: |
          response=$(curl -s "https://${{ secrets.VERCEL_URL }}/api/tokens")
          echo "Token health: $response"

          # Check for warnings
          has_warnings=$(echo "$response" | grep -o '"hasWarnings":true' || true)
          if [ -n "$has_warnings" ]; then
            echo "::warning::Token health warnings detected"
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Dashboard Health Check Failed';
            const body = `
            ## Health Check Failed

            The dashboard health check failed at ${new Date().toISOString()}.

            Please check:
            - MongoDB connection
            - Redis connection
            - API credentials

            [View Health Endpoint](https://${{ secrets.VERCEL_URL }}/api/health)
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['health-check-failure', 'automated']
              });
            }
